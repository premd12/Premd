<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rajdhani Pro AI ‚Äì Dual Pattern System</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --gold: #ffd700; 
            --red-circle: #ff4757; 
            --blue-circle: #2e86de; 
            --green-line: #00ff88; 
            --bg: #0f172a; 
            --panel: #1e293b; 
        }
        * { box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { margin: 0; background: var(--bg); color: #fff; overflow-x: hidden; }

        #home-screen {
            height: 100vh; width: 100vw; display: flex; flex-direction: column;
            align-items: center; justify-content: center; text-align: center;
            background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%);
        }
        .hero-title { font-size: 3rem; color: var(--gold); margin: 0; text-shadow: 0 0 20px rgba(255,215,0,0.3); }
        .hero-sub { opacity: 0.7; letter-spacing: 2px; margin-bottom: 30px; }
        .enter-btn {
            background: var(--gold); color: #000; padding: 15px 40px;
            font-size: 1.2rem; font-weight: 800; border: none; border-radius: 50px;
            cursor: pointer; transition: 0.3s; box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }

        #main-app { display: none; padding: 15px; }
        .toolbar { background: var(--panel); padding: 12px; border-radius: 12px; margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; border: 1px solid rgba(255,255,255,0.1); }
        
        .table-container { position: relative; background: #fff; border-radius: 10px; padding: 5px; box-shadow: 0 0 30px rgba(0,0,0,0.5); display: inline-block; }
        table { border-collapse: collapse; color: #000; font-size: 14px; position: relative; z-index: 5; }
        td, th { border: 1px solid #ddd; padding: 8px 4px; text-align: center; font-weight: bold; width: 45px; height: 45px; transition: 0.2s; }
        th { background: #1e293b; color: white; font-size: 11px; }
        
        /* Two Different Circle Colors */
        .circle-red { border: 3px solid var(--red-circle) !important; border-radius: 50% !important; background: rgba(255, 71, 87, 0.2); }
        .circle-blue { border: 3px solid var(--blue-circle) !important; border-radius: 50% !important; background: rgba(46, 134, 222, 0.2); }
        
        canvas { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 4; }

        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 20px; }
        .card { background: var(--panel); padding: 15px; border-radius: 12px; border-top: 3px solid var(--gold); }
        .card h3 { margin: 0 0 10px 0; color: var(--gold); font-size: 14px; text-transform: uppercase; }

        #popup { position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); background: #fff; border-radius: 15px; display: none; z-index: 100; padding: 15px; color: #000; width: 95%; max-width: 450px; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; z-index: 90; }
        button { cursor: pointer; border-radius: 6px; border: none; font-weight: bold; padding: 8px 15px; }
    </style>
</head>
<body>

<div id="home-screen">
    <h1 class="hero-title">Rajdhani PRO AI</h1>
    <p class="hero-sub">DUAL PATTERN DETECTION SYSTEM</p>
    <button class="enter-btn" onclick="startApp()">START ANALYSIS</button>
</div>

<div id="main-app">
    <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom:10px;">
        <h2 style="color:var(--gold); margin:0;">Rajdhani AI</h2>
        <button onclick="location.reload()" style="background:#dc3545; color:white;">Reset</button>
    </div>

    <div class="toolbar">
        <input type="file" id="csv" style="display:none">
        <button onclick="document.getElementById('csv').click()" style="background:#444; color:white;">üìÇ CSV</button>
        <button onclick="addRow()" style="background:#444; color:white;">‚ûï ROW</button>
        <button onclick="saveData()" style="background:#28a745; color:white;">üíæ SAVE</button>
        <button onclick="clearData()" style="background:#777; color:white;">üóëÔ∏è CLEAR</button>
    </div>

    <center>
        <div class="table-container">
            <canvas id="mainCanvas"></canvas>
            <table id="tbl"></table>
        </div>
    </center>

    <div class="dashboard">
        <div class="card"><h3>‚úî Matches Found</h3><div id="checks"></div></div>
        <div class="card"><h3>ü§ñ AI Analysis</h3><div id="ai">Ready...</div></div>
        <div class="card"><h3>üîÆ Future Prediction</h3><div id="future">...</div></div>
    </div>
</div>

<div class="overlay" id="overlay" onclick="closePopup()"></div>
<div id="popup">
    <button onclick="closePopup()" style="float:right; background:#000; color:white;">CLOSE</button>
    <h3 style="margin: 0 0 15px 0;">Dual-Pattern View</h3>
    <center><div class="table-container" style="border: 1px solid #ddd;"><canvas id="popCanvas"></canvas><div id="popData"></div></div></center>
</div>

<script>
const STORAGE_KEY="pdata_Rajdhani_v3";
let targetCol=null, activeMark=null;

const FAMILY = {
 "22":["22","27","72","77"], "11":["11","61","66","16"], "33":["33","83","88","38"], "99":["99","44","49","94"], "55":["50","00","05","55"],
 "12":["12","17","21","26","62","67","71","76"], "13":["13","18","31","36","63","68","81","86"], "14":["14","19","41","46","64","69","91","96"],  
 "15":["01","06","10","15","51","56","60","65"], "23":["23","28","32","37","73","78","82","87"], "24":["24","29","42","47","74","79","92","97"],  
 "25":["02","07","20","25","52","57","70","75"], "34":["34","39","43","48","84","89","93","98"], "35":["03","08","30","35","53","58","80","85"],  
 "45":["04","09","40","45","54","59","90","95"]
};

let data=JSON.parse(localStorage.getItem(STORAGE_KEY)) || Array(10).fill().map(()=>Array(5).fill("**"));

function startApp() { document.getElementById('home-screen').style.display = 'none'; document.getElementById('main-app').style.display = 'block'; draw(); }

function fam(v){for(let k in FAMILY) if(FAMILY[k].includes(v)) return k; return "NA";}
function smartMatch(a,b){ if(a=="**"||b=="**") return false; return fam(a)===fam(b); }
function norm(v){if(!v||v=="**")return "**"; v=String(v); return v.length==1?"0"+v:v;}

function draw(){
 let h="<tr><th>MON</th><th>TUE</th><th>WED</th><th>THU</th><th>FRI</th></tr>";
 data.forEach((r,ri)=>{
  h+="<tr>";
  r.forEach((c,ci)=>{
   let cls = "";
   if(activeMark) {
       let val = getPatternType(ri, ci);
       if(val === 1) cls = "circle-red";
       if(val === 2) cls = "circle-blue";
   }
   h+=`<td class="${cls}" contenteditable oninput="edit(${ri},${ci},this)" onclick="${c=='**'?'makePattern('+ri+','+ci+')':'' }">${c}</td>`;
  });
  h+="</tr>";
 });
 document.getElementById("tbl").innerHTML=h;
 if(activeMark) setTimeout(() => drawLines("mainCanvas", document.getElementById("tbl")), 50);
}

function getPatternType(ri, ci){
    if(!activeMark) return 0;
    let i = ri - activeMark.start;
    if(i >= 0 && i < activeMark.shape.length) return activeMark.shape[i][ci];
    return 0;
}

function drawLines(cvsId, tblEl) {
    const cvs = document.getElementById(cvsId);
    const ctx = cvs.getContext("2d");
    cvs.width = tblEl.offsetWidth; cvs.height = tblEl.offsetHeight;
    ctx.clearRect(0,0,cvs.width,cvs.height);
    const tRect = tblEl.getBoundingClientRect();
    
    // Draw Red Lines
    drawGroup(tblEl, ".circle-red", "#ff4757", ctx, tRect);
    // Draw Blue Lines
    drawGroup(tblEl, ".circle-blue", "#2e86de", ctx, tRect);
}

function drawGroup(tblEl, selector, color, ctx, tRect) {
    const cells = tblEl.querySelectorAll(selector);
    if(cells.length < 2) return;
    ctx.strokeStyle = color; ctx.lineWidth = 2.5; ctx.beginPath();
    cells.forEach((c, idx) => {
        const r = c.getBoundingClientRect();
        const x = r.left - tRect.left + r.width/2;
        const y = r.top - tRect.top + r.height/2;
        if(idx === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
    });
    ctx.stroke();
}

function edit(r,c,el){ data[r][c]=norm(el.innerText.trim()); }
function addRow(){ data.push(["**","**","**","**","**"]); draw(); }
function saveData(){ localStorage.setItem(STORAGE_KEY,JSON.stringify(data)); alert("Saved!"); }
function clearData(){ if(confirm("Clear All?")){ localStorage.clear(); location.reload(); }}

// --- Updated makePattern Function for Dynamic Detection ---

function makePattern(r, c) {
    targetCol = c; // Jis column me click kiya, prediction wahi hogi
    let b1 = "**", b2 = "**";
    let b1Pos = [], b2Pos = [];

    // 1. Scan up to 12 rows above the clicked cell
    let startR = Math.max(0, r - 12);
    
    // Sabse pehle upar ki taraf jodi dhundna shuru karte hain
    for (let i = r - 1; i >= startR; i--) {
        for (let j = 0; j < 5; j++) {
            let val = data[i][j];
            if (val !== "**") {
                let currentFam = fam(val);
                
                // Pehli Family (Red)
                if (b1 === "**") {
                    b1 = val;
                    b1Pos.push({r: i, c: j});
                } else if (fam(val) === fam(b1) && b1Pos.length < 2) {
                    b1Pos.push({r: i, c: j});
                } 
                // Dusri Family (Blue)
                else if (b2 === "**" && currentFam !== fam(b1)) {
                    b2 = val;
                    b2Pos.push({r: i, c: j});
                } else if (b2 !== "**" && currentFam === fam(b2) && b2Pos.length < 2) {
                    b2Pos.push({r: i, c: j});
                }
            }
        }
    }

    if (b1Pos.length < 2 || b2Pos.length < 2) {
        alert("Is cell ke upar paryapt (enough) pattern nahi mila. Kam se kam 2 different families ki 2-2 jodi honi chahiye.");
        return;
    }

    // 2. Create a Relative Shape Map
    // Hum pattern ki height nikalte hain (Sabse upar wali jodi se clicked cell tak)
    let topMost = Math.min(b1Pos[b1Pos.length-1].r, b2Pos[b2Pos.length-1].r);
    let shapeHeight = r - topMost;
    let shape = Array(shapeHeight).fill().map(() => Array(5).fill(0));

    b1Pos.forEach(p => { shape[p.r - topMost][p.c] = 1; });
    b2Pos.forEach(p => { shape[p.r - topMost][p.c] = 2; });

    // 3. Purane matches clear karke naye dhundna
    searchMultiPattern(shape, b1, b2);
}

function searchMultiPattern(shape, b1, b2) {
    let matches = [];
    // Pure record me ye 'shape' dhundna (History Search)
    for (let i = 0; i <= data.length - shape.length - 1; i++) {
        let ok = true;
        for (let k = 0; k < shape.length; k++) {
            for (let j = 0; j < 5; j++) {
                let type = shape[k][j];
                if (type === 1 && !smartMatch(data[i + k][j], b1)) { ok = false; break; }
                if (type === 2 && !smartMatch(data[i + k][j], b2)) { ok = false; break; }
            }
            if (!ok) break;
        }
        
        // Agar pattern match ho gaya, to dekho uske niche prediction wali jodi available hai ya nahi
        if (ok) {
            matches.push({ index: i });
        }
    }
    
    if(matches.length === 0) {
        document.getElementById("checks").innerHTML = "<p style='font-size:12px; opacity:0.6;'>History me aisa koi pattern nahi mila.</p>";
    } else {
        showChecks(shape, matches, b1, b2);
    }
}
function showChecks(shape, matches, b1, b2){
    const container = document.getElementById("checks");
    container.innerHTML = "";
    matches.forEach(m => {
        let d = document.createElement("div");
        d.style = "background:#2a2a2a; margin:5px 0; padding:10px; cursor:pointer; border-radius:8px; border-left:4px solid var(--gold);";
        d.innerHTML = `Match at Row ${m.index + 1} <span style='float:right; color:var(--green-line)'>‚ûî</span>`;
        d.onclick = () => { activeMark={start:m.index, shape:shape}; draw(); showOne(shape, m.index); };
        container.appendChild(d);
    });
    updateAdvancedAI(shape, matches);
}

function showOne(shape, idx){
    let html="<table id='popTbl'>";
    for(let i=0; i<shape.length; i++){
        html+="<tr>";
        data[idx+i].forEach((v,j)=>{
            let cls = shape[i][j] === 1 ? "circle-red" : (shape[i][j] === 2 ? "circle-blue" : "");
            html+=`<td class="${cls}">${v}</td>`;
        });
        html+="</tr>";
    }
    document.getElementById("popData").innerHTML=html+"</table>";
    document.getElementById("popup").style.display="block";
    document.getElementById("overlay").style.display="block";
    setTimeout(()=>drawLines("popCanvas", document.getElementById("popTbl")), 100);
}

function updateAdvancedAI(shape, matches) {
    let pool = [];
    matches.forEach(m => {
        let nextR = m.index + shape.length;
        if(nextR < data.length && data[nextR][targetCol] !== "**") pool.push(data[nextR][targetCol]);
    });

    document.getElementById("ai").innerHTML = pool.length ? 
        `<p style='color:var(--green-line)'>Dual Pattern Confirmed</p><small>Hits found: ${pool.length}</small>` : "Seeking historical data...";
    
    if (pool.length > 0) {
        let unique = [...new Set(pool)].slice(0, 3);
        document.getElementById("future").innerHTML = `<div style='font-size:1.4rem; color:var(--gold); font-weight:800;'>${unique.join(" - ")}</div><small>AI Prediction Pairs</small>`;
    } else {
        document.getElementById("future").innerHTML = "No direct matches.";
    }
}

function closePopup(){ document.getElementById("popup").style.display="none"; document.getElementById("overlay").style.display="none"; }

document.getElementById("csv").onchange = e => {
    let fr = new FileReader();
    fr.onload = () => {
        data = fr.result.split('\n').filter(l=>l.trim()).map(l => l.split(',').map(v => norm(v.trim())).slice(0,5));
        draw();
    };
    fr.readAsText(e.target.files[0]);
};
</script>
</body>
</html>
